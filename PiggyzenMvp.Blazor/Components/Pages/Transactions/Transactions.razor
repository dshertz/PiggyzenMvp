@page "/transactions"
@rendermode InteractiveServer
@using System.Linq
@inject IHttpClientFactory HttpClientFactory

<h2>Transaktioner</h2>

<div class="mb-4 d-flex flex-wrap align-items-end gap-3">
    <div>
        <label for="search" class="form-label mb-1">Sök</label>
        <div class="input-group">
            <input id="search"
                   class="form-control"
                   @bind="searchText"
                   @bind:event="oninput"
                   placeholder="Sök beskrivning..." />
            <span class="input-group-text bg-white">
                <i class="bi bi-search"></i>
            </span>
        </div>
    </div>
    <div>
        <label class="form-label mb-1">Filtrera</label>
        <div class="btn-group" role="group" aria-label="Filter">
            <button type="button"
                    class="btn btn-outline-primary @(filterCategory == "all" ? "active" : "")"
                    @onclick='() => SetFilterCategory("all")'>
                Alla
            </button>
            <button type="button"
                    class="btn btn-outline-success @(filterCategory == "categorized" ? "active" : "")"
                    @onclick='() => SetFilterCategory("categorized")'>
                Kategoriserade
            </button>
            <button type="button"
                    class="btn btn-outline-warning @(filterCategory == "uncategorized" ? "active" : "")"
                    @onclick='() => SetFilterCategory("uncategorized")'>
                Ej kategoriserade
            </button>
        </div>
    </div>
    <div class="ms-auto d-flex gap-2 align-items-center">
        <span class="badge bg-success">Kategoriserade: @CategorizedCount</span>
        <span class="badge bg-warning text-dark">Ej kategoriserade: @UncategorizedCount</span>
        <span class="badge bg-info text-dark">Totalt: @(transactions?.Count ?? 0)</span>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger" role="alert">@errorMessage</div>
}

@if (!string.IsNullOrWhiteSpace(successMessage))
{
    <div class="alert alert-success" role="alert">@successMessage</div>
}

@if (transactions is null)
{
    <p><em>Laddar...</em></p>
}
else if (FilteredTransactions.Count == 0)
{
    <p>Inga transaktioner hittades.</p>
}
else
{
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>Datum</th>
                <th>Beskrivning</th>
                <th>Belopp</th>
                <th>Saldo</th>
                <th>Type</th>
                <th>Category</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var tx in FilteredTransactions)
            {
                <tr @key="tx.Id">
                    <td>@tx.TransactionDate.ToShortDateString()</td>
                    <td>@tx.Description</td>
                    <td>@tx.Amount.ToString("F2")</td>
                    <td>@(tx.Balance?.ToString("F2") ?? "-")</td>
                    <td>@(tx.TypeName ?? "—")</td>
                    <td>
                        <select class="form-select form-select-sm"
                                value="@GetSelectedCategoryValue(tx)"
                                @onchange="async e => await OnCategoryChanged(tx, e)"
                                disabled="@savingTransactions.Contains(tx.Id)">
                            <option value="">—</option>
                            @foreach (var category in categories)
                            {
                                <option value="@category.Id">@GetCategoryDisplayName(category)</option>
                            }
                        </select>
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

@code {
    private List<TransactionDto>? transactions;
    private List<CategoryDto> categories = new();
    private HashSet<int> savingTransactions = new();
    private string? errorMessage;
    private string? successMessage;

    // Filter state
    private string searchText = "";
    private string filterCategory = "all";

    // Filtrerad lista
    private List<TransactionDto> FilteredTransactions =>
        transactions?
            .Where(tx =>
                (string.IsNullOrWhiteSpace(searchText) || tx.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase)) &&
                (filterCategory == "all" ||
                 (filterCategory == "categorized" && tx.CategoryId != null) ||
                 (filterCategory == "uncategorized" && tx.CategoryId == null))
            )
            .OrderByDescending(t => t.TransactionDate)
            .ToList()
        ?? new();

    // Status info
    private int CategorizedCount => transactions?.Count(tx => tx.CategoryId != null) ?? 0;
    private int UncategorizedCount => transactions?.Count(tx => tx.CategoryId == null) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");

            var txTask = client.GetFromJsonAsync<List<TransactionDto>>("api/transactions");
            var catTask = client.GetFromJsonAsync<List<CategoryDto>>("api/categories");

            await Task.WhenAll(txTask!, catTask!);

            transactions = txTask?.Result ?? new();
            categories = catTask?.Result ?? new();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Fel vid hämtning: {ex.Message}");
            transactions = new();
            categories = new();
            errorMessage = "Kunde inte läsa in data.";
        }
    }

    private string GetSelectedCategoryValue(TransactionDto tx) =>
        tx.CategoryId?.ToString() ?? string.Empty;

    private string GetCategoryDisplayName(CategoryDto category)
    {
        if (category.ParentCategoryId is int parentId)
        {
            var parent = categories.FirstOrDefault(c => c.Id == parentId);
            if (parent != null)
            {
                return $"{parent.Name} / {category.Name}";
            }
        }

        return category.Name;
    }

    private async Task OnCategoryChanged(TransactionDto tx, ChangeEventArgs e)
    {
        var rawValue = e.Value?.ToString();
        if (string.IsNullOrWhiteSpace(rawValue))
            return;

        if (!int.TryParse(rawValue, out var categoryId))
            return;

        savingTransactions.Add(tx.Id);
        successMessage = null;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var request = new SetCategoryRequest(categoryId);

            var response = await client.PutAsJsonAsync(
                $"api/transactions/{tx.Id}/category",
                request
            );

            if (response.IsSuccessStatusCode)
            {
                tx.CategoryId = categoryId;
                UpdateCategoryFields(tx);
                successMessage = "Kategori uppdaterad!";
            }
            else
            {
                var details = await response.Content.ReadAsStringAsync();
                errorMessage = $"Kunde inte uppdatera kategori. ({(int)response.StatusCode}) {details}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            savingTransactions.Remove(tx.Id);
            StateHasChanged();
        }
    }

    private void UpdateCategoryFields(TransactionDto tx)
    {
        var category = tx.CategoryId is int id
            ? categories.FirstOrDefault(c => c.Id == id)
            : null;

        if (category is null)
        {
            tx.CategoryId = null;
            tx.CategoryName = null;
            tx.TypeId = null;
            tx.TypeName = null;
            return;
        }

        tx.CategoryName = category.Name;

        if (category.IsSystemCategory)
        {
            tx.TypeId = category.Id;
            tx.TypeName = category.Name;
        }
        else if (category.ParentCategoryId is int parentId)
        {
            tx.TypeId = parentId;
            tx.TypeName = categories.FirstOrDefault(c => c.Id == parentId)?.Name;
        }
        else
        {
            tx.TypeId = null;
            tx.TypeName = null;
        }
    }

    private void SetFilterCategory(string category)
    {
        filterCategory = category;
    }
}
