@page "/transactions"
@rendermode InteractiveServer
@using System.Globalization
@using System.Linq
@using PiggyzenMvp.Blazor.DTOs
@using PiggyzenMvp.Blazor.DTOs.Transactions
@using PiggyzenMvp.Blazor.Services
@inject IHttpClientFactory HttpClientFactory
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedLocalStorage BrowserStorage
@inject TransactionFilterState FilterState

<div class="transactions-workspace d-flex flex-column flex-xl-row gap-4">
    <div class="transactions-main flex-fill">
        <div class="filter-stack">
            <div class="transactions-filter-bar">
                <div class="filter-field filter-search">
                    <div class="input-group compact-search">
                        <InputText id="search"
                                   class="form-control"
                                   @bind-Value="searchText"
                                   oninput="this.dispatchEvent(new Event('change'))"
                                   @onchange="OnSearchChanged"
                                   placeholder="Sök..." />
                        <span class="input-group-text bg-white">
                            <i class="bi bi-search"></i>
                        </span>
                    </div>
                </div>
                <div class="filter-field filter-right">
                    <div class="filter-block filter-status">
                        <div class="btn-group filter-toggle" role="group" aria-label="Statusfilter">
                            <button type="button"
                                    class="btn btn-outline-primary @(filterStateLoaded && filterCategory == "all" ? "active" : "")"
                                    @onclick='() => SetFilterCategory("all")'>
                                Alla
                            </button>
                            <button type="button"
                                    class="btn btn-outline-success @(filterStateLoaded && filterCategory == "categorized" ? "active" : "")"
                                    @onclick='() => SetFilterCategory("categorized")'>
                                Kategoriserade
                            </button>
                            <button type="button"
                                    class="btn btn-outline-warning @(filterStateLoaded && filterCategory == "uncategorized" ? "active" : "")"
                                    @onclick='() => SetFilterCategory("uncategorized")'>
                                Ej kategoriserade
                            </button>
                        </div>
                    </div>
                    <div class="filter-block filter-date-mode">
                        <div class="btn-group filter-toggle" role="group" aria-label="Datumläge">
                            <button type="button"
                                    class="btn btn-outline-secondary @(dateFilterMode == DateFilterMode.All ? "active" : "")"
                                    @onclick="() => SetDateFilterMode(DateFilterMode.All)">
                                Alla datum
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary @(dateFilterMode == DateFilterMode.Yearly ? "active" : "")"
                                    @onclick="() => SetDateFilterMode(DateFilterMode.Yearly)">
                                År
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary @(dateFilterMode == DateFilterMode.Monthly ? "active" : "")"
                                    @onclick="() => SetDateFilterMode(DateFilterMode.Monthly)">
                                Månad
                            </button>
                        </div>
                    </div>
                    <div class="filter-block filter-period">
                        <div class="period-controls">
                            <div class="btn-group period-nav" role="group" aria-label="Periodnavigation">
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        disabled="@IsPeriodNavigationDisabled"
                                        @onclick="() => StepPeriod(-1)">
                                    <i class="bi bi-chevron-left"></i>
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary period-label @(showAdvancedFilters ? "active" : "")"
                                        aria-pressed="@showAdvancedFilters"
                                        @onclick="ToggleFilterPanel">
                                    @CurrentPeriodLabel
                                </button>
                                <button type="button"
                                        class="btn btn-outline-secondary"
                                        disabled="@IsPeriodNavigationDisabled"
                                        @onclick="() => StepPeriod(1)">
                                    <i class="bi bi-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            @if (showAdvancedFilters && HasPeriodData)
            {
                <div class="date-filter-panel">
                    <div class="card-body">
                        <div class="filter-panel-tools d-flex flex-wrap align-items-center gap-2 mb-3">
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm"
                                    disabled="@IsDateControlsDisabled"
                                    @onclick="ToggleDateMultiSelect">
                                @(isDateMultiSelect ? "Multi på" : "Multi av")
                            </button>
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm"
                                    @onclick="ToggleFilterPanel">
                                Dölj filter
                            </button>
                            <button type="button"
                                    class="btn btn-link text-decoration-none btn-sm px-0"
                                    disabled="@IsDateControlsDisabled"
                                    @onclick="ClearDateFilters">
                                Rensa datum
                            </button>
                        </div>
                        @if (dateFilterMode == DateFilterMode.All)
                        {
                            <div class="text-muted small">Alla datum visas.</div>
                        }
                        else if (dateFilterMode == DateFilterMode.Yearly)
                        {
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <span class="text-muted text-uppercase small fw-semibold">År</span>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var year in YearOptionsDisplay)
                                    {
                                        <button type="button"
                                                class="@GetYearButtonClass(year)"
                                                @onclick="() => ToggleYearSelection(year)">
                                            @year
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        else if (dateFilterMode == DateFilterMode.Monthly)
                        {
                            <div class="d-flex flex-wrap align-items-center gap-2">
                                <span class="text-muted text-uppercase small fw-semibold">Period</span>
                                <div class="d-flex flex-wrap gap-2">
                                    @foreach (var option in MonthOptionsDisplay)
                                    {
                                        <button type="button"
                                                class="@GetMonthButtonClass(option)"
                                                @onclick="() => ToggleMonthSelection(option)">
                                            @GetMonthLabel(option)
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
        <div class="transactions-content">
            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <div class="alert alert-danger" role="alert">@errorMessage</div>
            }

            @if (!string.IsNullOrWhiteSpace(successMessage))
            {
                <div class="alert alert-success" role="alert">@successMessage</div>
            }

            @if (transactions is null)
            {
                <p><em>Laddar...</em></p>
            }
            else if (FilteredTransactions.Count == 0)
            {
                <p>Inga transaktioner hittades.</p>
            }
            else
            {
                <div class="transactions-table-card">
                    <div class="card-body p-0">
                        <div class="table-responsive transactions-table-scroll">
                            <table class="table table-bordered table-striped mb-0 transactions-table">
                                <thead>
                                    <tr>
                                        <th class="text-center" style="width: 48px;">
                                            <input type="checkbox"
                                                   class="form-check-input"
                                                   @onchange="ToggleSelectAllFiltered"
                                                   checked="@AreAllFilteredSelected" />
                                        </th>
                                        <th>Datum</th>
                                        <th>Beskrivning</th>
                                        <th class="text-end transactions-table__amount">Belopp</th>
                                        <th class="text-end transactions-table__balance">Saldo</th>
                                        <th>Type</th>
                                        <th>Category</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var tx in FilteredTransactions)
                                    {
                                        <tr @key="tx.Id">
                                            <td class="text-center transactions-table__select">
                                                <input type="checkbox"
                                                       class="form-check-input"
                                                       checked="@IsSelected(tx.Id)"
                                                       @onchange="e => ToggleSelection(tx.Id, e)" />
                                            </td>
                                            <td>@tx.TransactionDate.ToShortDateString()</td>
                                            <td>@tx.Description</td>
                                            <td class="text-end transactions-table__amount">@tx.Amount.ToString("F2")</td>
                                            <td class="text-end transactions-table__balance">@(tx.Balance?.ToString("F2") ?? "-")</td>
                                            <td>@(tx.TypeName ?? "—")</td>
                                            <td>@(tx.CategoryName ?? "Ej vald")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>

    <aside class="transactions-side-panel @(isSidePanelOpen ? "open" : "collapsed")">
        <div class="side-panel__inner">
            <button type="button"
                    class="side-panel__close btn btn-link text-decoration-none"
                    @onclick="ToggleSidePanel">
                Stäng panel
            </button>
            <div class="side-panel__section">
                <div class="side-panel__title">Markerade transaktioner</div>
                @if (selectedTransactionIds.Count > 0)
                {
                    <div class="selection-card">
                        <div class="selection-card__count">
                            <strong>@selectedTransactionIds.Count</strong> markerade.
                        </div>
                        <div class="selection-card__category">
                            <div class="text-uppercase small text-muted">Vald kategori</div>
                            <div class="selected-category-pill">@GetBulkCategoryName()</div>
                            <button class="btn btn-link text-decoration-none btn-sm px-0"
                                    type="button"
                                    @onclick="ClearBulkCategorySelection"
                                    disabled="@(bulkCategoryId is null)">
                                Rensa kategori
                            </button>
                        </div>
                        <div class="d-flex flex-column gap-2">
                            <button class="btn btn-primary w-100"
                                    @onclick="CategorizeSelectedAsync"
                                    disabled="@IsBulkActionDisabled">
                                @(isBulkCategorizing ? "Kategoriserar..." : $"Kategorisera {selectedTransactionIds.Count}")
                            </button>
                            <button class="btn btn-link text-decoration-none px-0"
                                    type="button"
                                    @onclick="ClearSelection">
                                Rensa markering
                            </button>
                        </div>
                    </div>
                }
                else
                {
                    <p class="text-muted small mb-0">Markera transaktioner i tabellen för att börja kategorisera.</p>
                }
            </div>

            <div class="side-panel__section">
                <div class="side-panel__title">Kategorisering</div>
                <div class="category-active mb-3">
                    <div>
                        <div class="text-uppercase small text-muted">Aktiv kategori</div>
                        <div class="fw-semibold">@GetBulkCategoryName()</div>
                    </div>
                </div>
                <div class="category-compact">
                    <div class="category-compact__column">
                        <div class="category-compact__list">
                            @if (CategoryGroupsDisplay.Any())
                            {
                                @foreach (var group in CategoryGroupsDisplay)
                                {
                                    <button type="button"
                                            class="@GetGroupButtonClass(group.Id)"
                                            @onclick="() => SelectCategoryGroup(group.Id)">
                                        <span>@group.DisplayName</span>
                                        <span class="category-row__chevron"></span>
                                    </button>
                                }
                            }
                            else
                            {
                                <div class="text-muted small p-2">Inga grupper att visa.</div>
                            }
                        </div>
                    </div>
                    <div class="category-compact__column">
                        <div class="category-compact__list category-compact__list--items">
                            @if (VisibleCategories.Any())
                            {
                                @foreach (var category in VisibleCategories)
                                {
                                    <button type="button"
                                            class="@GetCategoryButtonClass(category.Id)"
                                            @onclick="() => SelectBulkCategory(category.Id)">
                                        <span>@category.EffectiveName</span>
                                    </button>
                                }
                            }
                            else
                            {
                                <div class="text-muted small p-2">Inga kategorier för vald grupp.</div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <button type="button"
            class="panel-floating-toggle btn btn-outline-secondary btn-sm"
            @onclick="ToggleSidePanel">
        @(isSidePanelOpen ? "Dölj panel" : "Visa panel")
    </button>
</div>


@code {
    private List<TransactionDto>? transactions;
    private List<CategoryDto> categories = new();
    private List<CategoryGroupDto> categoryGroups = new();
    private HashSet<int> selectedTransactionIds = new();
    private int? bulkCategoryId;
    private bool isBulkCategorizing;
    private string? errorMessage;
    private string? successMessage;
    private int? selectedCategoryGroupId;
    private bool isSidePanelOpen = true;
    private bool showAdvancedFilters;

    // Filter state
    private string searchText = "";
    private string? filterCategory = null;
    private const string FilterStateKey = "transactions_filter_state";
    private bool filterStateLoaded;
    private DateFilterMode dateFilterMode = DateFilterMode.Monthly;
    private bool isDateMultiSelect;
    private HashSet<int> selectedYears = new();
    private HashSet<YearMonth> selectedYearMonths = new();
    private int? activeYear;
    private int? activeMonth;
    private List<int> availableYears = new();
    private List<YearMonth> availableYearMonths = new();
    private static readonly CultureInfo SwedishCulture = CultureInfo.GetCultureInfo("sv-SE");

    // Filtrerad lista
    private List<TransactionDto> FilteredTransactions =>
        transactions?
            .Where(tx =>
                (string.IsNullOrWhiteSpace(searchText) || tx.Description.Contains(searchText, StringComparison.OrdinalIgnoreCase)) &&
                ((filterCategory ?? "all") == "all" ||
                 ((filterCategory ?? "all") == "categorized" && tx.CategoryId != null) ||
                 ((filterCategory ?? "all") == "uncategorized" && tx.CategoryId == null)) &&
                MatchesDateFilter(tx)
            )
            .OrderByDescending(t => t.TransactionDate)
            .ToList()
        ?? new();

    private IEnumerable<CategoryGroupDto> CategoryGroupsDisplay => categoryGroups;

    private IEnumerable<CategoryDto> VisibleCategories =>
        categories
            .Where(c => selectedCategoryGroupId == null || c.GroupId == selectedCategoryGroupId)
            .OrderBy(c => c.SortOrder)
            .ThenBy(c => c.DisplayName);

    private string GetBulkCategoryName() =>
        bulkCategoryId is int id
            ? categories.FirstOrDefault(c => c.Id == id)?.EffectiveName ?? "Ingen vald"
            : "Ingen vald";

    // Status info
    private int CategorizedCount => transactions?.Count(tx => tx.CategoryId != null) ?? 0;
    private int UncategorizedCount => transactions?.Count(tx => tx.CategoryId == null) ?? 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            await LoadFilterStateAsync();

            var client = HttpClientFactory.CreateClient("ApiClient");

            await Task.WhenAll(
                LoadTransactionsAsync(client),
                LoadCategoriesAsync(client)
            );

            RefreshAvailablePeriods();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Fel vid hämtning: {ex.Message}");
            transactions = new();
            categories = new();
            errorMessage = "Kunde inte läsa in data.";
        }
        finally
        {
            filterStateLoaded = true;
        }
    }

    private bool AreAllFilteredSelected
    {
        get
        {
            var filtered = FilteredTransactions;
            if (filtered.Count == 0)
                return false;

            return filtered.All(t => selectedTransactionIds.Contains(t.Id));
        }
    }

    private bool IsSelected(int transactionId) => selectedTransactionIds.Contains(transactionId);

    private void ToggleSelection(int transactionId, ChangeEventArgs e)
    {
        var isChecked = e.Value is bool b && b;
        if (isChecked)
        {
            selectedTransactionIds.Add(transactionId);
        }
        else
        {
            selectedTransactionIds.Remove(transactionId);
        }
    }

    private void ToggleSelectAllFiltered(ChangeEventArgs e)
    {
        var filtered = FilteredTransactions;
        var selectAll = e.Value is bool b && b;

        if (selectAll)
        {
            foreach (var tx in filtered)
                selectedTransactionIds.Add(tx.Id);
        }
        else
        {
            foreach (var tx in filtered)
                selectedTransactionIds.Remove(tx.Id);
        }
    }

    private bool IsBulkActionDisabled =>
        isBulkCategorizing || bulkCategoryId is null || selectedTransactionIds.Count == 0;

    private string GetGroupButtonClass(int groupId)
    {
        var isActive = selectedCategoryGroupId == groupId;
        return isActive ? "category-row active" : "category-row";
    }

    private string GetCategoryButtonClass(int categoryId)
    {
        var isActive = bulkCategoryId == categoryId;
        return isActive ? "category-row active" : "category-row";
    }

    private void SelectCategoryGroup(int groupId)
    {
        selectedCategoryGroupId = groupId;
    }

    private void SelectBulkCategory(int categoryId)
    {
        bulkCategoryId = categoryId;
        var category = categories.FirstOrDefault(c => c.Id == categoryId);
        if (category is not null)
        {
            selectedCategoryGroupId = category.GroupId;
        }
    }

    private void ClearBulkCategorySelection()
    {
        bulkCategoryId = null;
    }

    private void ToggleSidePanel()
    {
        isSidePanelOpen = !isSidePanelOpen;
    }

    private void ToggleFilterPanel()
    {
        showAdvancedFilters = !showAdvancedFilters;
    }

    private void ClearSelection()
    {
        selectedTransactionIds.Clear();
    }

    private async Task CategorizeSelectedAsync()
    {
        if (transactions is null)
            return;

        if (bulkCategoryId is null || selectedTransactionIds.Count == 0)
            return;

        isBulkCategorizing = true;
        successMessage = null;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var selected = transactions
                .Where(t => selectedTransactionIds.Contains(t.Id))
                .ToList();

            var manualTargets = selected.Where(t => t.CategoryId == null).ToList();
            var changeTargets = selected.Where(t => t.CategoryId != null).ToList();

            var categorizedCount = 0;
            var updatedCount = 0;
            var autoCategorizedCount = 0;
            var combinedErrors = new List<ManualCategorizeError>();

            // Process uncategorized (manual) grouped by sign to satisfy backend validation
            foreach (var group in manualTargets.GroupBy(t => t.Amount >= 0m))
            {
                var manualRequests = group
                    .Select(t => new CategorizeRequest(t.Id, bulkCategoryId.Value))
                    .ToList();

                var manualResponse = await client.PostAsJsonAsync(
                    "api/transactions/manual-categorize",
                    manualRequests
                );

                if (!manualResponse.IsSuccessStatusCode)
                {
                    var details = await manualResponse.Content.ReadAsStringAsync();
                    errorMessage =
                        $"Kunde inte kategorisera valda transaktioner. ({(int)manualResponse.StatusCode}) {details}";
                    return;
                }

                var manualResult =
                    await manualResponse.Content.ReadFromJsonAsync<ManualCategorizeResponse>()
                    ?? new ManualCategorizeResponse();

                categorizedCount += manualResult.Categorized;
                autoCategorizedCount += manualResult.AutoCategorized;
                combinedErrors.AddRange(manualResult.Errors);

                var manualFailedIds = manualResult.Errors.Select(e => e.TransactionId).ToHashSet();

                foreach (var tx in group)
                {
                    if (manualFailedIds.Contains(tx.Id))
                        continue;

                    tx.CategoryId = bulkCategoryId;
                    UpdateCategoryFields(tx);
                    selectedTransactionIds.Remove(tx.Id);
                }
            }

            // Process already categorized (change) grouped by sign to satisfy backend validation
            foreach (var group in changeTargets.GroupBy(t => t.Amount >= 0m))
            {
                var changeRequests = group
                    .Select(t => new ChangeCategoryRequest(t.Id, bulkCategoryId.Value))
                    .ToList();

                var changeResponse = await client.PostAsJsonAsync(
                    "api/transactions/change-category",
                    changeRequests
                );

                if (!changeResponse.IsSuccessStatusCode)
                {
                    var details = await changeResponse.Content.ReadAsStringAsync();
                    errorMessage =
                        $"Kunde inte uppdatera kategoriserade transaktioner. ({(int)changeResponse.StatusCode}) {details}";
                    return;
                }

                var changeResult =
                    await changeResponse.Content.ReadFromJsonAsync<ChangeCategoryResponse>()
                    ?? new ChangeCategoryResponse();

                updatedCount += changeResult.Updated;
                var changeFailedIds = changeResult.Errors.Select(e => e.TransactionId).ToHashSet();
                var changeErrors = changeResult.Errors
                    .Select(e => new ManualCategorizeError { TransactionId = e.TransactionId, Message = e.Message })
                    .ToList();
                combinedErrors.AddRange(changeErrors);

                foreach (var tx in group)
                {
                    if (changeFailedIds.Contains(tx.Id))
                        continue;

                    tx.CategoryId = bulkCategoryId;
                    UpdateCategoryFields(tx);
                    selectedTransactionIds.Remove(tx.Id);
                }
            }

            var successParts = new List<string>();
            if (categorizedCount > 0)
                successParts.Add($"Kategoriserade {categorizedCount} transaktion(er)");
            if (updatedCount > 0)
                successParts.Add($"Uppdaterade {updatedCount} transaktion(er)");
            if (autoCategorizedCount > 0)
                successParts.Add($"Auto-kategoriserade {autoCategorizedCount} liknande transaktion(er)");

            successMessage = successParts.Count > 0 ? string.Join(". ", successParts) + "." : null;

            var anyChanges = categorizedCount > 0 || updatedCount > 0 || autoCategorizedCount > 0;
            if (anyChanges)
            {
                await RefreshTransactionsAsync();
                selectedTransactionIds.Clear();
            }

            if (combinedErrors.Count > 0)
            {
                var errorList = string.Join(
                    ", ",
                    combinedErrors.Select(e => $"{e.TransactionId}: {e.Message}")
                );
                errorMessage = $"Vissa transaktioner kunde inte hanteras: {errorList}";
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBulkCategorizing = false;
            StateHasChanged();
        }
    }

    private void UpdateCategoryFields(TransactionDto tx)
    {
        var category = tx.CategoryId is int id
            ? categories.FirstOrDefault(c => c.Id == id)
            : null;

        if (category is null)
        {
            tx.CategoryId = null;
            tx.CategoryName = null;
            tx.TypeId = null;
            tx.TypeName = null;
            return;
        }

        tx.CategoryName = category.EffectiveName;
        tx.TypeId = category.GroupId;
        tx.TypeName = category.GroupDisplayName;
    }

    private IEnumerable<int> YearOptionsDisplay => availableYears.OrderByDescending(y => y);
    private IEnumerable<YearMonth> MonthOptionsDisplay =>
        availableYearMonths.OrderByDescending(p => p.Year).ThenByDescending(p => p.Month);
    private bool HasPeriodData => availableYearMonths.Count > 0;
    private bool HasActiveSinglePeriod =>
        dateFilterMode == DateFilterMode.Yearly
            ? activeYear.HasValue
            : dateFilterMode == DateFilterMode.Monthly
                ? activeYear.HasValue && activeMonth.HasValue
                : true;
    private bool IsDateControlsDisabled => dateFilterMode == DateFilterMode.All || !HasPeriodData;
    private bool IsPeriodNavigationDisabled =>
        dateFilterMode == DateFilterMode.All || isDateMultiSelect || !HasActiveSinglePeriod;
    private string CurrentPeriodLabel => dateFilterMode switch
    {
        DateFilterMode.All => "Alla datum",
        DateFilterMode.Yearly => activeYear?.ToString() ?? "Välj år",
        DateFilterMode.Monthly => activeYear.HasValue && activeMonth.HasValue
            ? new DateTime(activeYear.Value, activeMonth.Value, 1).ToString("MMMM yyyy", SwedishCulture)
            : "Välj månad",
        _ => "Alla datum"
    };

    private void SetDateFilterMode(DateFilterMode mode)
    {
        if (dateFilterMode == mode)
            return;

        dateFilterMode = mode;
        if (mode == DateFilterMode.All)
        {
            isDateMultiSelect = false;
        }
        else if (mode == DateFilterMode.Yearly)
        {
            activeMonth = null;
        }

        EnsurePeriodSelectionIsValid();
        _ = SaveFilterStateAsync();
    }

    private void ToggleDateMultiSelect()
    {
        if (IsDateControlsDisabled)
            return;

        isDateMultiSelect = !isDateMultiSelect;
        if (isDateMultiSelect)
        {
            SeedMultiSelectionFromActive();
        }
        else
        {
            if (dateFilterMode == DateFilterMode.Yearly)
            {
                if (selectedYears.Count > 0)
                {
                    activeYear = selectedYears.OrderByDescending(y => y).First();
                }
                selectedYears.Clear();
            }
            else if (dateFilterMode == DateFilterMode.Monthly)
            {
                if (selectedYearMonths.Count > 0)
                {
                    var latest = selectedYearMonths
                        .OrderBy(p => p.Year)
                        .ThenBy(p => p.Month)
                        .Last();
                    activeYear = latest.Year;
                    activeMonth = latest.Month;
                }
                selectedYearMonths.Clear();
            }
        }

        _ = SaveFilterStateAsync();
    }

    private void ToggleYearSelection(int year)
    {
        if (dateFilterMode != DateFilterMode.Yearly || !availableYears.Contains(year))
            return;

        if (isDateMultiSelect)
        {
            if (!selectedYears.Add(year))
                selectedYears.Remove(year);
        }
        else
        {
            activeYear = year;
        }

        _ = SaveFilterStateAsync();
    }

    private void ToggleMonthSelection(YearMonth option)
    {
        if (dateFilterMode != DateFilterMode.Monthly || !availableYearMonths.Contains(option))
            return;

        if (isDateMultiSelect)
        {
            if (!selectedYearMonths.Add(option))
                selectedYearMonths.Remove(option);
        }
        else
        {
            activeYear = option.Year;
            activeMonth = option.Month;
        }

        _ = SaveFilterStateAsync();
    }

    private void StepPeriod(int direction)
    {
        if (IsPeriodNavigationDisabled)
            return;

        if (dateFilterMode == DateFilterMode.Yearly && activeYear.HasValue)
        {
            var currentIndex = availableYears.IndexOf(activeYear.Value);
            var nextIndex = currentIndex + direction;
            if (nextIndex >= 0 && nextIndex < availableYears.Count)
            {
                activeYear = availableYears[nextIndex];
            }
        }
        else if (dateFilterMode == DateFilterMode.Monthly && activeYear.HasValue && activeMonth.HasValue)
        {
            var current = new YearMonth(activeYear.Value, activeMonth.Value);
            var currentIndex = availableYearMonths.IndexOf(current);
            var nextIndex = currentIndex + direction;
            if (nextIndex >= 0 && nextIndex < availableYearMonths.Count)
            {
                var target = availableYearMonths[nextIndex];
                activeYear = target.Year;
                activeMonth = target.Month;
            }
        }

        _ = SaveFilterStateAsync();
    }

    private void ClearDateFilters()
    {
        if (!HasPeriodData)
            return;

        dateFilterMode = DateFilterMode.Monthly;
        isDateMultiSelect = false;
        var latest = availableYearMonths.Last();
        activeYear = latest.Year;
        activeMonth = latest.Month;
        selectedYears.Clear();
        selectedYearMonths.Clear();
        EnsurePeriodSelectionIsValid();

        _ = SaveFilterStateAsync();
    }

    private string GetYearButtonClass(int year)
    {
        var isActive = isDateMultiSelect ? selectedYears.Contains(year) : activeYear == year;
        return GetChipClass(isActive);
    }

    private string GetMonthButtonClass(YearMonth option)
    {
        var isActive = isDateMultiSelect
            ? selectedYearMonths.Contains(option)
            : activeYear == option.Year && activeMonth == option.Month;
        return GetChipClass(isActive);
    }

    private static string GetChipClass(bool isActive) =>
        isActive ? "btn btn-sm btn-primary" : "btn btn-sm btn-outline-secondary";

    private static string GetMonthLabel(YearMonth option)
    {
        var date = new DateTime(option.Year, option.Month, 1);
        var monthAbbreviation = date.ToString("MMM", SwedishCulture).TrimEnd('.');
        return $"{date:yyyy} {monthAbbreviation.ToLower(SwedishCulture)}.";
    }

    private void RefreshAvailablePeriods()
    {
        if (transactions is null || transactions.Count == 0)
        {
            availableYears = new();
            availableYearMonths = new();
            activeYear = null;
            activeMonth = null;
            selectedYears.Clear();
            selectedYearMonths.Clear();
            dateFilterMode = DateFilterMode.All;
            isDateMultiSelect = false;
            return;
        }

        availableYears = transactions
            .Select(t => t.TransactionDate.Year)
            .Distinct()
            .OrderBy(y => y)
            .ToList();

        availableYearMonths = transactions
            .Select(t => new YearMonth(t.TransactionDate.Year, t.TransactionDate.Month))
            .Distinct()
            .OrderBy(p => p.Year)
            .ThenBy(p => p.Month)
            .ToList();

        EnsurePeriodSelectionIsValid();
    }

    private void EnsurePeriodSelectionIsValid()
    {
        if (!HasPeriodData)
            return;

        var latest = availableYearMonths.Last();

        if (!activeYear.HasValue || !availableYears.Contains(activeYear.Value))
        {
            activeYear = latest.Year;
        }

        if (dateFilterMode == DateFilterMode.Monthly)
        {
            var desired = activeYear.HasValue && activeMonth.HasValue
                ? new YearMonth(activeYear.Value, activeMonth.Value)
                : latest;

            if (!availableYearMonths.Contains(desired))
            {
                var fallbacks = availableYearMonths.Where(p => p.Year == activeYear).ToList();
                if (fallbacks.Count > 0)
                {
                    desired = fallbacks.Last();
                }
                else
                {
                    desired = latest;
                }
            }

            activeYear = desired.Year;
            activeMonth = desired.Month;
        }
        else if (dateFilterMode == DateFilterMode.Yearly)
        {
            activeMonth = null;
        }

        selectedYears.RemoveWhere(year => !availableYears.Contains(year));
        selectedYearMonths.RemoveWhere(period => !availableYearMonths.Contains(period));

        if (isDateMultiSelect)
        {
            if (dateFilterMode == DateFilterMode.Yearly && selectedYears.Count == 0 && activeYear.HasValue)
            {
                selectedYears.Add(activeYear.Value);
            }
            else if (dateFilterMode == DateFilterMode.Monthly &&
                     selectedYearMonths.Count == 0 &&
                     activeYear.HasValue &&
                     activeMonth.HasValue)
            {
                selectedYearMonths.Add(new YearMonth(activeYear.Value, activeMonth.Value));
            }
        }
    }

    private void SeedMultiSelectionFromActive()
    {
        if (dateFilterMode == DateFilterMode.Yearly && activeYear.HasValue)
        {
            selectedYears.Add(activeYear.Value);
        }
        else if (dateFilterMode == DateFilterMode.Monthly && activeYear.HasValue && activeMonth.HasValue)
        {
            selectedYearMonths.Add(new YearMonth(activeYear.Value, activeMonth.Value));
        }
    }

    private bool MatchesDateFilter(TransactionDto tx)
    {
        if (dateFilterMode == DateFilterMode.All)
            return true;

        var year = tx.TransactionDate.Year;
        if (dateFilterMode == DateFilterMode.Yearly)
        {
            if (isDateMultiSelect)
            {
                return selectedYears.Count == 0 || selectedYears.Contains(year);
            }

            return !activeYear.HasValue || year == activeYear.Value;
        }

        var month = tx.TransactionDate.Month;
        if (isDateMultiSelect)
        {
            return selectedYearMonths.Count == 0 || selectedYearMonths.Contains(new YearMonth(year, month));
        }

        if (!activeYear.HasValue || !activeMonth.HasValue)
            return true;

        return year == activeYear.Value && month == activeMonth.Value;
    }

    private void SetFilterCategory(string category)
    {
        filterCategory = category;
        _ = SaveFilterStateAsync();
    }

    private async Task OnSearchChanged(ChangeEventArgs e)
    {
        searchText = e.Value?.ToString() ?? "";
        await SaveFilterStateAsync();
    }

    private readonly record struct YearMonth(int Year, int Month)
    {
        public string ToStorageKey() => $"{Year:D4}-{Month:D2}";

        public static bool TryParse(string? input, out YearMonth period)
        {
            period = default;
            if (string.IsNullOrWhiteSpace(input))
                return false;

            var parts = input.Split('-', StringSplitOptions.RemoveEmptyEntries);
            if (parts.Length != 2)
                return false;

            if (int.TryParse(parts[0], out var year) && int.TryParse(parts[1], out var month) && month is >= 1 and <= 12)
            {
                period = new YearMonth(year, month);
                return true;
            }

            return false;
        }
    }

    private async Task LoadFilterStateAsync()
    {
        // 1) Läs från in-memory state (Blazor circuit). Ingen async/lagg.
        filterCategory = FilterState.FilterCategory;
        searchText = FilterState.SearchText;
        dateFilterMode = FilterState.DateMode;
        isDateMultiSelect = FilterState.IsDateMultiSelect;
        activeYear = FilterState.ActiveYear;
        activeMonth = FilterState.ActiveMonth;
        selectedYears = new HashSet<int>(FilterState.SelectedYears ?? new List<int>());
        selectedYearMonths = FilterState.SelectedYearMonths?
            .Select(value => YearMonth.TryParse(value, out var period) ? period : (YearMonth?)null)
            .Where(p => p.HasValue)
            .Select(p => p!.Value)
            .ToHashSet() ?? new HashSet<YearMonth>();

        // 2) Hämta ev. persisted state (för browser refresh). Uppdatera både lokal state och container.
        try
        {
            var result = await BrowserStorage.GetAsync<FilterStatePayload>(FilterStateKey);
            if (result.Success && result.Value is FilterStatePayload state)
            {
                filterCategory = state.FilterCategory ?? filterCategory ?? "all";
                searchText = state.SearchText ?? searchText ?? string.Empty;
                dateFilterMode = state.DateMode;
                isDateMultiSelect = state.IsDateMultiSelect;
                activeYear = state.ActiveYear;
                activeMonth = state.ActiveMonth;
                selectedYears = state.SelectedYears?.ToHashSet() ?? selectedYears;
                selectedYearMonths = state.SelectedYearMonths?
                    .Select(value => YearMonth.TryParse(value, out var period) ? period : (YearMonth?)null)
                    .Where(p => p.HasValue)
                    .Select(p => p!.Value)
                    .ToHashSet() ?? selectedYearMonths;
                FilterState.FilterCategory = filterCategory ?? "all";
                FilterState.SearchText = searchText ?? string.Empty;
                FilterState.DateMode = dateFilterMode;
                FilterState.IsDateMultiSelect = isDateMultiSelect;
                FilterState.ActiveYear = activeYear;
                FilterState.ActiveMonth = activeMonth;
                FilterState.SelectedYears = selectedYears.ToList();
                FilterState.SelectedYearMonths = selectedYearMonths.Select(p => p.ToStorageKey()).ToList();
                FilterState.IsLoadedFromStorage = true;
            }
        }
        catch
        {
            // ignore storage errors
        }
    }

    private async Task SaveFilterStateAsync()
    {
        FilterState.FilterCategory = filterCategory ?? "all";
        FilterState.SearchText = searchText ?? string.Empty;
        FilterState.DateMode = dateFilterMode;
        FilterState.IsDateMultiSelect = isDateMultiSelect;
        FilterState.ActiveYear = activeYear;
        FilterState.ActiveMonth = activeMonth;
        FilterState.SelectedYears = selectedYears.ToList();
        FilterState.SelectedYearMonths = selectedYearMonths.Select(p => p.ToStorageKey()).ToList();

        var state = new FilterStatePayload
        {
            SearchText = FilterState.SearchText,
            FilterCategory = FilterState.FilterCategory,
            DateMode = FilterState.DateMode,
            IsDateMultiSelect = FilterState.IsDateMultiSelect,
            ActiveYear = FilterState.ActiveYear,
            ActiveMonth = FilterState.ActiveMonth,
            SelectedYears = FilterState.SelectedYears,
            SelectedYearMonths = FilterState.SelectedYearMonths,
        };
        try
        {
            await BrowserStorage.SetAsync(FilterStateKey, state);
        }
        catch
        {
            // ignore storage errors
        }
    }

    private async Task LoadTransactionsAsync(HttpClient client)
    {
        var data = await client.GetFromJsonAsync<List<TransactionDto>>("api/transactions");
        transactions = data ?? new();
    }

    private async Task LoadCategoriesAsync(HttpClient client)
    {
        var data = await client.GetFromJsonAsync<List<CategoryGroupDto>>("api/categories") ?? new();

        categoryGroups = data
            .Select(group =>
            {
                group.Categories = group.Categories
                    .Where(c => c.IsActive && !c.IsHidden)
                    .OrderBy(c => c.SortOrder)
                    .ThenBy(c => c.DisplayName)
                    .ToList();
                return group;
            })
            .Where(group => group.Categories.Count > 0)
            .OrderBy(g => g.SortOrder)
            .ThenBy(g => g.DisplayName)
            .ToList();

        categories = categoryGroups
            .SelectMany(g => g.Categories)
            .ToList();

        if (selectedCategoryGroupId is null || categoryGroups.All(g => g.Id != selectedCategoryGroupId))
        {
            selectedCategoryGroupId = categoryGroups.FirstOrDefault()?.Id;
        }
    }

    private async Task RefreshTransactionsAsync()
    {
        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            await LoadTransactionsAsync(client);
            RefreshAvailablePeriods();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Fel vid uppdatering: {ex.Message}");
            errorMessage = "Kunde inte uppdatera transaktionerna efter kategorisering.";
        }
    }

    private class FilterStatePayload
    {
        public string? SearchText { get; set; }
        public string? FilterCategory { get; set; }
        public DateFilterMode DateMode { get; set; } = DateFilterMode.Monthly;
        public bool IsDateMultiSelect { get; set; }
        public int? ActiveYear { get; set; }
        public int? ActiveMonth { get; set; }
        public List<int>? SelectedYears { get; set; }
        public List<string>? SelectedYearMonths { get; set; }
    }
}
