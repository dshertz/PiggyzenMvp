@using System.Linq
@using PiggyzenMvp.Blazor.Services
@namespace PiggyzenMvp.Blazor.Components.Pages.Transactions

<section class="transactions-filter-bar">
    <div class="filter-bar-inner">
        <div class="topbar-row search-row">
            <div class="search-input">
                <input id="transaction-search"
                       class="form-control"
                       type="text"
                       value="@SearchText"
                       placeholder="Sök transaktioner"
                       @oninput="HandleSearchInput" />
                <span class="search-icon bi bi-search"></span>
            </div>
        </div>

        <div class="filter-tag-panel">
            <div class="tag-panel-header">
                <button type="button" class="tag-toggle-btn">
                    <span class="bi bi-sliders"></span>
                    Filter
                </button>
                <button type="button"
                        class="tag-clear-btn"
                        disabled="@(!HasActiveFilter)"
                        @onclick="ClearFilters">
                    <span class="bi bi-trash"></span>
                </button>
            </div>
            <div class="tag-palette">
                @foreach (var option in FilterOptions)
                {
                    <button type="button"
                            class="tag-option @(IsFilterActive(option.Key) ? "active" : string.Empty)"
                            @onclick="() => ToggleFilter(option.Key)">
                        @option.Label
                    </button>
                }
            </div>
            @if (HasActiveFilter)
            {
                <div class="active-tags">
                    @foreach (var option in ActiveFilters)
                    {
                        <button type="button"
                                class="active-tag"
                                @onclick="() => ToggleFilter(option.Key)">
                            <span>@option.Label</span>
                            <span class="bi bi-x"></span>
                        </button>
                    }
                </div>
            }
            else
            {
                <div class="tag-empty">Inga filter valda</div>
            }
        </div>

        <div class="date-controls-block">
            <div class="mode-buttons">
                <button type="button"
                        class="mode-btn @(DateFilterMode == DateFilterMode.All ? "active" : string.Empty)"
                        @onclick="() => ChangeMode(DateFilterMode.All)">
                    Alla datum
                </button>
                <button type="button"
                        class="mode-btn @(DateFilterMode == DateFilterMode.Yearly ? "active" : string.Empty)"
                        @onclick="() => ChangeMode(DateFilterMode.Yearly)">
                    År
                </button>
                <button type="button"
                        class="mode-btn @(DateFilterMode == DateFilterMode.Monthly ? "active" : string.Empty)"
                        @onclick="() => ChangeMode(DateFilterMode.Monthly)">
                    Månad
                </button>
            </div>

            @if (DateFilterMode != DateFilterMode.All)
            {
                <div class="period-actions">
                    <button type="button"
                            class="nav-btn"
                            disabled="@IsPeriodNavigationDisabled"
                            @onclick="() => OnStepPeriod.InvokeAsync(-1)">
                        <i class="bi bi-chevron-left"></i>
                    </button>
                    <button type="button"
                            class="current-period-btn"
                            disabled="@IsDateControlsDisabled"
                            @onclick="ToggleSelector">
                        @CurrentPeriodLabel
                        <span class="bi @(showSelector ? "bi-chevron-up" : "bi-chevron-down")"></span>
                    </button>
                    <button type="button"
                            class="nav-btn"
                            disabled="@IsPeriodNavigationDisabled"
                            @onclick="() => OnStepPeriod.InvokeAsync(1)">
                        <i class="bi bi-chevron-right"></i>
                    </button>

                    <button type="button"
                            class="pill-btn"
                            disabled="@IsDateControlsDisabled"
                            @onclick="() => OnToggleDateMultiSelect.InvokeAsync()">
                        @(IsDateMultiSelect ? "Multi på" : "Multi av")
                    </button>
                    <button type="button"
                            class="pill-btn secondary"
                            disabled="@IsDateControlsDisabled"
                            @onclick="() => OnClearDateFilters.InvokeAsync()">
                        Rensa
                    </button>
                </div>
            }
            else
            {
                <div class="period-actions">
                    <span class="text-muted small">Alla datum visas.</span>
                </div>
            }
        </div>

        @if (showSelector)
        {
            <div class="period-selector">
                @if (DateFilterMode == DateFilterMode.Yearly)
                {
                    <div class="chip-row">
                        @foreach (var year in YearOptions)
                        {
                            <button type="button"
                                    class="@GetYearButtonClass(year)"
                                    @onclick="() => OnYearSelectionToggled.InvokeAsync(year)">
                                @year
                            </button>
                        }
                    </div>
                }
                else if (DateFilterMode == DateFilterMode.Monthly)
                {
                    <div class="chip-row">
                        @foreach (var option in MonthOptions)
                        {
                            <button type="button"
                                    class="@GetMonthButtonClass(option)"
                                    @onclick="() => OnMonthSelectionToggled.InvokeAsync(option)">
                                @GetMonthLabel(option)
                            </button>
                        }
                    </div>
                }
            </div>
        }
    </div>
</section>

@code {
    [Parameter] public string? SearchText { get; set; }
    [Parameter] public EventCallback<string?> OnSearchTextChanged { get; set; }
    [Parameter] public string? FilterCategory { get; set; }
    [Parameter] public bool FilterStateLoaded { get; set; }
    [Parameter] public EventCallback<string> OnFilterCategoryChanged { get; set; }

    [Parameter] public DateFilterMode DateFilterMode { get; set; }
    [Parameter] public bool IsDateMultiSelect { get; set; }
    [Parameter] public bool IsDateControlsDisabled { get; set; }
    [Parameter] public bool IsPeriodNavigationDisabled { get; set; }
    [Parameter] public string CurrentPeriodLabel { get; set; } = "Alla datum";
    [Parameter] public EventCallback<DateFilterMode> OnDateFilterModeChanged { get; set; }
    [Parameter] public EventCallback OnToggleDateMultiSelect { get; set; }
    [Parameter] public EventCallback OnClearDateFilters { get; set; }
    [Parameter] public EventCallback<int> OnStepPeriod { get; set; }

    [Parameter] public IEnumerable<int> YearOptions { get; set; } = Enumerable.Empty<int>();
    [Parameter] public IEnumerable<YearMonth> MonthOptions { get; set; } = Enumerable.Empty<YearMonth>();
    [Parameter] public EventCallback<int> OnYearSelectionToggled { get; set; }
    [Parameter] public EventCallback<YearMonth> OnMonthSelectionToggled { get; set; }
    [Parameter] public Func<int, string>? YearButtonClassSelector { get; set; }
    [Parameter] public Func<YearMonth, string>? MonthButtonClassSelector { get; set; }
    [Parameter] public Func<YearMonth, string>? MonthLabelSelector { get; set; }

    private bool isSelectorOpen;
    private const string AllFilterKey = "all";
    private const string CategorizedFilterKey = "categorized";
    private const string UncategorizedFilterKey = "uncategorized";
    private static readonly FilterOption[] FilterOptionsList =
    [
        new(CategorizedFilterKey, "Kategoriserade"),
        new(UncategorizedFilterKey, "Ej kategoriserade")
    ];
    private bool showSelector => isSelectorOpen && DateFilterMode != DateFilterMode.All;
    private bool HasActiveFilter => !string.Equals(FilterCategory ?? AllFilterKey, AllFilterKey, StringComparison.OrdinalIgnoreCase);
    private IEnumerable<FilterOption> FilterOptions => FilterOptionsList;
    private IEnumerable<FilterOption> ActiveFilters => FilterOptions.Where(o => IsFilterActive(o.Key));

    protected override void OnParametersSet()
    {
        if (DateFilterMode == DateFilterMode.All && isSelectorOpen)
        {
            isSelectorOpen = false;
        }
    }

    private Task HandleSearchInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        return OnSearchTextChanged.InvokeAsync(value);
    }

    private bool IsFilterActive(string key) =>
        (FilterCategory ?? AllFilterKey).Equals(key, StringComparison.OrdinalIgnoreCase);

    private Task ToggleFilter(string key)
    {
        if (IsFilterActive(key))
        {
            return ClearFilters();
        }

        return OnFilterCategoryChanged.InvokeAsync(key);
    }

    private Task ClearFilters() => OnFilterCategoryChanged.InvokeAsync(AllFilterKey);

    private string GetYearButtonClass(int year) =>
        YearButtonClassSelector?.Invoke(year) ?? "btn btn-sm btn-outline-secondary";

    private string GetMonthButtonClass(YearMonth option) =>
        MonthButtonClassSelector?.Invoke(option) ?? "btn btn-sm btn-outline-secondary";

    private string GetMonthLabel(YearMonth option) =>
        MonthLabelSelector?.Invoke(option) ?? $"{option.Year}-{option.Month:D2}";

    private readonly record struct FilterOption(string Key, string Label);

    private void ToggleSelector()
    {
        if (DateFilterMode == DateFilterMode.All || IsDateControlsDisabled)
        {
            isSelectorOpen = false;
            return;
        }

        isSelectorOpen = !isSelectorOpen;
    }

    private void ChangeMode(DateFilterMode mode)
    {
        if (DateFilterMode == mode)
        {
            if (mode != DateFilterMode.All)
            {
                ToggleSelector();
            }
            else
            {
                isSelectorOpen = false;
            }
            return;
        }

        isSelectorOpen = mode != DateFilterMode.All;
        _ = OnDateFilterModeChanged.InvokeAsync(mode);
    }
}
