@using System.Linq
@using Microsoft.AspNetCore.Components.Web
@using PiggyzenMvp.Blazor.Services
@namespace PiggyzenMvp.Blazor.Components.Pages.Transactions

<section class="transactions-filter-bar">
    <div class="filter-bar-inner">
        <div class="topbar-row search-row">
            <div class="search-input">
                <input id="transaction-search"
                       class="form-control"
                       type="text"
                       value="@SearchText"
                       placeholder="Sök transaktioner"
                       @oninput="HandleSearchInput" />
                <span class="search-icon bi bi-search"></span>
            </div>
        </div>

        <div class="filter-tag-panel">
            <div class="tag-row">
                <button type="button" class="tag-toggle-btn" @onclick="ToggleFilterPanel">
                    <span class="bi bi-sliders"></span>
                    @(filtersExpanded ? "Dölj filter" : "Visa filter")
                </button>
                @if (HasActiveFilter)
                {
                    <button type="button"
                            class="tag-clear-btn"
                            title="Rensa filter"
                            @onclick="ClearFilters">
                        <span class="bi bi-trash"></span>
                    </button>
                    <div class="tag-active-list">
                        @foreach (var option in ActiveFilters)
                        {
                            <button type="button"
                                    class="active-tag"
                                    @onclick="() => ToggleFilter(option.Key)">
                                <span>@option.Label</span>
                                <span class="bi bi-x"></span>
                            </button>
                        }
                    </div>
                }
            </div>
            @if (filtersExpanded)
            {
                var generalSection = FilterSections.FirstOrDefault();
                var categorySections = FilterSections.Skip(1).ToList();

                if (generalSection?.Options.Count > 0)
                {
                    <div class="tag-general-row">
                        @foreach (var option in generalSection.Options.Where(o => !IsFilterActive(o.Key)))
                        {
                            <button type="button"
                                    class="tag-option"
                                    @onclick="() => ToggleFilter(option.Key)">
                                @option.Label
                            </button>
                        }
                    </div>
                }

                if (categorySections.Count > 0)
                {
                    <div class="category-header-row">
                        <button type="button"
                                class="group-chip @(categoriesCollapsed ? "active" : string.Empty)"
                                @onclick="ToggleCategoriesCollapse">
                            @(categoriesCollapsed ? "Visa kategorier" : "Dölj kategorier")
                        </button>
                        <button type="button"
                                class="category-search-btn"
                                title="Sök kategori"
                                @onclick="ToggleCategorySearch">
                            <span class="bi bi-search"></span>
                        </button>
                    </div>

                    @if (showCategorySearch)
                    {
                        <div class="category-search-panel">
                            <input class="category-search-input"
                                   placeholder="Sök kategori…"
                                   value="@categorySearchText"
                                   @oninput="OnCategorySearchInput"
                                   @onkeydown="OnCategorySearchKeyDown" />
                            <div class="category-search-results">
                                @if (!FilteredCategoryOptions.Any())
                                {
                                    <div class="category-search-empty text-muted small px-2 py-1">
                                        Inga kategorier matchar.
                                    </div>
                                }
                                else
                                {
                                    @foreach (var option in FilteredCategoryOptions.Select((value, index) => new { value, index }))
                                    {
                                        var isSelected = option.index == highlightedCategoryIndex;
                                        <button type="button"
                                                class="category-search-item @(option.value.IsGroup ? "group" : "category") @(isSelected ? "active" : string.Empty)"
                                                @onclick="() => SelectCategoryFromSearch(option.value)">
                                            @if (option.value.IsGroup)
                                            {
                                                <span class="category-search-label group">@option.value.Label</span>
                                            }
                                            else
                                            {
                                                <span class="category-search-label category">@option.value.Label</span>
                                            }
                                        </button>
                                    }
                                }
                            </div>
                        </div>
                    }

                    if (!categoriesCollapsed)
                    {
                        <div class="tag-columns">
                            @foreach (var section in categorySections)
                            {
                                if (section.Options.Count == 0)
                                {
                                    continue;
                                }

                                var groupChip = section.Options.First();
                                var categoryChips = section.Options.Skip(1);

                                <div class="tag-column">
                                    <div class="group-chip-row">
                                        <button type="button"
                                                class="group-chip @(IsFilterActive(groupChip.Key) ? "active" : string.Empty)"
                                                @onclick="() => ToggleFilter(groupChip.Key)">
                                            @groupChip.Label
                                        </button>
                                    </div>

                                    <div class="tag-column-categories">
                                        @foreach (var chip in categoryChips)
                                        {
                                            if (IsHiddenByParent(chip) || IsFilterActive(chip.Key))
                                            {
                                                continue;
                                            }

                                            <button type="button"
                                                    class="tag-option"
                                                    @onclick="() => ToggleFilter(chip.Key)">
                                                @chip.Label
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    }
                }
            }
        </div>

        <TransactionsDateFilterControls DateFilterMode="@DateFilterMode"
                                        IsDateMultiSelect="@IsDateMultiSelect"
                                        IsDateControlsDisabled="@IsDateControlsDisabled"
                                        IsPeriodNavigationDisabled="@IsPeriodNavigationDisabled"
                                        CurrentPeriodLabel="@CurrentPeriodLabel"
                                        OnDateFilterModeChanged="OnDateFilterModeChanged"
                                        OnToggleDateMultiSelect="OnToggleDateMultiSelect"
                                        OnClearDateFilters="OnClearDateFilters"
                                        OnStepPeriod="OnStepPeriod"
                                        YearOptions="@YearOptions"
                                        MonthOptions="@MonthOptions"
                                        OnYearSelectionToggled="OnYearSelectionToggled"
                                        OnMonthSelectionToggled="OnMonthSelectionToggled"
                                        YearButtonClassSelector="@YearButtonClassSelector"
                                        MonthButtonClassSelector="@MonthButtonClassSelector"
                                        MonthLabelSelector="@MonthLabelSelector" />
    </div>
</section>

@code {
    [Parameter] public string? SearchText { get; set; }
    [Parameter] public EventCallback<string?> OnSearchTextChanged { get; set; }
    [Parameter] public string? FilterCategory { get; set; }
    [Parameter] public EventCallback<string> OnFilterCategoryChanged { get; set; }

    [Parameter] public DateFilterMode DateFilterMode { get; set; }
    [Parameter] public bool IsDateMultiSelect { get; set; }
    [Parameter] public bool IsDateControlsDisabled { get; set; }
    [Parameter] public bool IsPeriodNavigationDisabled { get; set; }
    [Parameter] public string CurrentPeriodLabel { get; set; } = "Alla datum";
    [Parameter] public EventCallback<DateFilterMode> OnDateFilterModeChanged { get; set; }
    [Parameter] public EventCallback OnToggleDateMultiSelect { get; set; }
    [Parameter] public EventCallback OnClearDateFilters { get; set; }
    [Parameter] public EventCallback<int> OnStepPeriod { get; set; }

    [Parameter] public IEnumerable<int> YearOptions { get; set; } = Enumerable.Empty<int>();
    [Parameter] public IEnumerable<YearMonth> MonthOptions { get; set; } = Enumerable.Empty<YearMonth>();
    [Parameter] public EventCallback<int> OnYearSelectionToggled { get; set; }
    [Parameter] public EventCallback<YearMonth> OnMonthSelectionToggled { get; set; }
    [Parameter] public Func<int, string>? YearButtonClassSelector { get; set; }
    [Parameter] public Func<YearMonth, string>? MonthButtonClassSelector { get; set; }
    [Parameter] public Func<YearMonth, string>? MonthLabelSelector { get; set; }
    [Parameter] public IReadOnlyList<FilterChipSection> FilterSections { get; set; } = Array.Empty<FilterChipSection>();

    private bool filtersExpanded = true;
    private bool categoriesCollapsed = true;
    private bool showCategorySearch;
    private string categorySearchText = string.Empty;
    private int highlightedCategoryIndex;
    private HashSet<string> selectedFilterKeys = new(StringComparer.OrdinalIgnoreCase);
    private const string AllFilterKey = "all";
    private List<FilterChipOption> filterOrder = new();
    private bool HasActiveFilter => selectedFilterKeys.Count > 0;
    private IEnumerable<FilterChipOption> ActiveFilters =>
        filterOrder.Where(o => selectedFilterKeys.Contains(o.Key));
    private IEnumerable<FilterChipOption> FilteredCategoryOptions =>
        filterOrder
            .Where(o => o.IsGroup || o.ParentKey is not null)
            .Where(o => string.IsNullOrWhiteSpace(categorySearchText) ||
                        o.Label.Contains(categorySearchText, StringComparison.OrdinalIgnoreCase))
            .Where(o => !IsFilterActive(o.Key) && !IsHiddenByParent(o))
            .ToList();

    protected override void OnParametersSet()
    {
        filterOrder = FilterSections?
            .SelectMany(section => section.Options)
            .ToList() ?? new List<FilterChipOption>();
        selectedFilterKeys = ParseFilterValues(FilterCategory);
    }

    private Task HandleSearchInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? string.Empty;
        return OnSearchTextChanged.InvokeAsync(value);
    }

    private bool IsFilterActive(string key) => selectedFilterKeys.Contains(key);

    private bool IsHiddenByParent(FilterChipOption option) =>
        option.ParentKey is not null && selectedFilterKeys.Contains(option.ParentKey);

    private Task ToggleFilter(string key)
    {
        var selection = new HashSet<string>(selectedFilterKeys, StringComparer.OrdinalIgnoreCase);
        if (!selection.Add(key))
        {
            selection.Remove(key);
        }

        var payload = BuildFilterPayload(selection);
        return OnFilterCategoryChanged.InvokeAsync(payload);
    }

    private Task ClearFilters() => OnFilterCategoryChanged.InvokeAsync(AllFilterKey);

    private void ToggleFilterPanel() => filtersExpanded = !filtersExpanded;

    private void ToggleCategoriesCollapse() => categoriesCollapsed = !categoriesCollapsed;

    private void ToggleCategorySearch()
    {
        showCategorySearch = !showCategorySearch;
        if (showCategorySearch)
        {
            highlightedCategoryIndex = 0;
        }
        else
        {
            categorySearchText = string.Empty;
        }
    }

    private void OnCategorySearchInput(ChangeEventArgs e)
    {
        categorySearchText = e.Value?.ToString() ?? string.Empty;
        highlightedCategoryIndex = 0;
    }

    private void OnCategorySearchKeyDown(KeyboardEventArgs e)
    {
        var options = FilteredCategoryOptions.ToList();
        if (options.Count == 0)
        {
            return;
        }

        if (e.Key == "ArrowDown")
        {
            highlightedCategoryIndex = Math.Min(highlightedCategoryIndex + 1, options.Count - 1);
        }
        else if (e.Key == "ArrowUp")
        {
            highlightedCategoryIndex = Math.Max(highlightedCategoryIndex - 1, 0);
        }
        else if (e.Key == "Enter")
        {
            var option = options.ElementAtOrDefault(highlightedCategoryIndex);
            if (option != null)
            {
                SelectCategoryFromSearch(option);
            }
        }
    }

    private async void SelectCategoryFromSearch(FilterChipOption option)
    {
        await ToggleFilter(option.Key);
        categorySearchText = string.Empty;
        highlightedCategoryIndex = 0;
    }

    private static HashSet<string> ParseFilterValues(string? raw)
    {
        var set = new HashSet<string>(StringComparer.OrdinalIgnoreCase);
        if (string.IsNullOrWhiteSpace(raw) || raw.Equals(AllFilterKey, StringComparison.OrdinalIgnoreCase))
        {
            return set;
        }

        var parts = raw.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries);
        foreach (var part in parts)
        {
            set.Add(part);
        }

        return set;
    }

    private string BuildFilterPayload(HashSet<string> selection)
    {
        if (selection.Count == 0)
        {
            return AllFilterKey;
        }

        var orderKeys = new HashSet<string>(filterOrder.Select(o => o.Key), StringComparer.OrdinalIgnoreCase);
        var ordered = filterOrder.Select(o => o.Key).Where(selection.Contains);
        var extras = selection.Where(key => !orderKeys.Contains(key))
            .OrderBy(key => key, StringComparer.OrdinalIgnoreCase);
        return string.Join(',', ordered.Concat(extras));
    }
}
