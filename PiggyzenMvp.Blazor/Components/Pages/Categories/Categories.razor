@page "/categories"
@rendermode InteractiveServer
@using System.Linq
@using System.Net.Http.Json
@using PiggyzenMvp.Blazor.DTOs
@inject IHttpClientFactory HttpClientFactory
@inject Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage.ProtectedLocalStorage BrowserStorage

<h2 class="mb-3">Kategorier</h2>

<div class="d-flex flex-wrap align-items-center gap-3 mb-4">
    <label class="form-check form-switch d-flex align-items-center mb-0">
        <input class="form-check-input" type="checkbox" role="switch" @bind="showHiddenCategories" @bind:after="OnPreferencesChanged" />
        <span class="ms-2">Visa dolda kategorier</span>
    </label>
    <small class="text-muted">Använd filtret för att visa kategorier som stängts av.</small>
</div>

<div class="mb-3 column-toggle-container">
    <button class="btn btn-sm btn-outline-secondary"
            type="button"
            @onclick="ToggleColumnMenu">
        Kolumner
        <span class="ms-1 bi @(isColumnMenuOpen ? "bi-chevron-up" : "bi-chevron-down")"></span>
    </button>
    <div class="column-toggle-menu @(isColumnMenuOpen ? "open" : string.Empty)">
        <label class="form-check form-switch d-flex align-items-center mb-2">
            <input class="form-check-input" type="checkbox" role="switch" @bind="showSystemDisplayColumn" @bind:after="OnPreferencesChanged" />
            <span class="ms-2">SystemDisplayName</span>
        </label>
        <label class="form-check form-switch d-flex align-items-center mb-2">
            <input class="form-check-input" type="checkbox" role="switch" @bind="showCustomDisplayColumn" @bind:after="OnPreferencesChanged" />
            <span class="ms-2">CustomDisplayName</span>
        </label>
        <label class="form-check form-switch d-flex align-items-center mb-0">
            <input class="form-check-input" type="checkbox" role="switch" @bind="showSortOrderColumn" @bind:after="OnPreferencesChanged" />
            <span class="ms-2">SortOrder</span>
        </label>
    </div>
</div>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isBusy && groups.Count == 0)
{
    <p><em>Laddar...</em></p>
}
else
{
    @foreach (var group in groups)
    {
        <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h3 class="fw-semibold mb-0">@group.DisplayName</h3>
            </div>

            @{
                var visibleCategories = GetVisibleCategories(group).ToList();
            }

            <div class="table-responsive categories-table-wrapper">
                <table class="table table-bordered table-striped table-sm categories-table mb-0">
                    <thead class="table-light text-uppercase small">
                        <tr>
                            <th class="col-display">DisplayName</th>
                            @if (showSystemDisplayColumn)
                            {
                                <th class="col-system-display">SystemDisplayName</th>
                            }
                            @if (showCustomDisplayColumn)
                            {
                                <th class="col-custom-display">CustomDisplayName</th>
                            }
                            @if (showSortOrderColumn)
                            {
                                <th class="col-sort-order">SortOrder</th>
                            }
                            <th class="col-status">Status</th>
                            <th class="col-actions text-end">Åtgärder</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (visibleCategories.Count == 0)
                        {
                            <tr>
                                <td colspan="@GetTableColumnSpan()" class="text-muted py-4 text-center">
                                    Inga kategorier visas med valt filter.
                                </td>
                            </tr>
                        }
                        else
                        {
                            @foreach (var category in visibleCategories)
                            {
                                var isEditing = editingCategoryId == category.Id;
                                <tr class="categories-row @(isEditing ? "table-active" : string.Empty)">
                                    <td class="col-display">
                                        @if (isEditing && !category.IsSystemCategory)
                                        {
                                            <input class="form-control form-control-sm"
                                                   @bind="editModel.DisplayName"
                                                   placeholder="Namn" />
                                        }
                                        else
                                        {
                                            <span class="category-name">@category.DisplayName</span>
                                        }
                                    </td>
                                    @if (showSystemDisplayColumn)
                                    {
                                        <td class="col-system-display">
                                            @category.SystemDisplayName
                                        </td>
                                    }
                                    @if (showCustomDisplayColumn)
                                    {
                                        <td class="col-custom-display">
                                            @if (category.IsSystemCategory)
                                            {
                                                if (isEditing)
                                                {
                                                    <input class="form-control form-control-sm"
                                                           @bind="editModel.DisplayName"
                                                           placeholder="Anpassat namn" />
                                                }
                                                else if (!string.IsNullOrWhiteSpace(category.CustomDisplayName))
                                                {
                                                    <span class="category-name">@category.CustomDisplayName</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted fst-italic">Använder systemnamn</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">—</span>
                                            }
                                        </td>
                                    }
                                    @if (showSortOrderColumn)
                                    {
                                        <td class="col-sort-order">
                                            @category.SortOrder
                                        </td>
                                    }
                                    <td class="col-status">
                                        <div class="status-icons">
                                            @if (category.IsSystemCategory)
                                            {
                                                <span class="text-secondary" title="Systemkategori">
                                                    <i class="bi bi-gear-fill"></i>
                                                </span>
                                            }
                                        </div>
                                    </td>
                                    <td class="text-end col-actions">
                                        @if (isEditing)
                                        {
                                            <div class="btn-group btn-group-sm justify-content-end">
                                                <button class="btn btn-primary"
                                                        disabled="@isBusy"
                                                        @onclick="() => SaveEditAsync(category.Id, category.IsSystemCategory)">
                                                    Spara
                                                </button>
                                                <button class="btn btn-outline-secondary"
                                                        disabled="@isBusy"
                                                        @onclick="CancelEdit">
                                                    Avbryt
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="btn-group btn-group-sm justify-content-end">
                                                <button class="btn btn-outline-secondary toggle-visibility @(category.IsEnabled ? "is-visible" : "is-hidden")"
                                                        title="@((category.IsEnabled ? "Dölj" : "Visa") + " kategori")"
                                                        disabled="@isBusy"
                                                        @onclick="() => SetEnabledAsync(category.Id, !category.IsEnabled)">
                                                    <i class="bi @(category.IsEnabled ? "bi-eye" : "bi-eye-slash")"></i>
                                                </button>
                                                <button class="btn btn-outline-secondary"
                                                        title="Redigera"
                                                        @onclick="() => StartEdit(category)">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger"
                                                        title="Ta bort"
                                                        disabled="@category.IsSystemCategory"
                                                        @onclick="() => DeleteCategoryAsync(category.Id)">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        }
                                    </td>
                                </tr>
                            }
                        }

                        <tr>
                            <td colspan="@GetTableColumnSpan()">
                                @if (creatingGroupId == group.Id)
                                {
                                    <div class="d-flex gap-3 align-items-center">
                                        <input class="form-control form-control-sm"
                                               placeholder="SystemDisplayName"
                                               @bind="createModel.SystemDisplayName" />
                                        <div class="ms-auto d-flex gap-2">
                                            <button class="btn btn-sm btn-primary" disabled="@isBusy"
                                                    @onclick="() => CreateCategoryAsync(group.Id)">
                                                Skapa
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary" disabled="@isBusy" @onclick="CancelCreate">
                                                Avbryt
                                            </button>
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <button class="btn btn-sm btn-outline-primary"
                                            @onclick="() => StartCreate(group.Id)">
                                        + Ny kategori
                                    </button>
                                }
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@code {
    private const string PreferenceStorageKey = "categories_table_preferences";
    private List<CategoryGroupDto> groups = new();
    private bool isBusy;
    private string? errorMessage;
    private bool showHiddenCategories;
    private bool isColumnMenuOpen;
    private bool showSystemDisplayColumn = true;
    private bool showCustomDisplayColumn = true;
    private bool showSortOrderColumn = true;

    private int? editingCategoryId;
    private int? creatingGroupId;

    private readonly CreateCategoryModel createModel = new();
    private readonly EditCategoryModel editModel = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadPreferencesAsync();
        await LoadAsync();
    }

    private async Task LoadAsync()
    {
        isBusy = true;
        errorMessage = null;
        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var result = await client.GetFromJsonAsync<List<CategoryGroupDto>>("api/categories");
            groups = result?
                .OrderBy(g => g.SortOrder)
                .Select(g =>
                {
                    g.Categories = g.Categories
                        .OrderBy(c => c.SortOrder)
                        .ThenBy(c => c.DisplayName)
                        .ToList();
                    return g;
                })
                .ToList() ?? new List<CategoryGroupDto>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            errorMessage = "Kunde inte läsa in kategorier.";
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

    private void StartCreate(int groupId)
    {
        creatingGroupId = groupId;
        createModel.SystemDisplayName = "";
    }

    private void CancelCreate()
    {
        creatingGroupId = null;
        createModel.SystemDisplayName = "";
    }

    private async Task CreateCategoryAsync(int groupId)
    {
        if (string.IsNullOrWhiteSpace(createModel.SystemDisplayName))
        {
            errorMessage = "Ange ett namn.";
            return;
        }

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");
            var req = new CreateCategoryRequest
            {
                SystemDisplayName = createModel.SystemDisplayName.Trim(),
                GroupId = groupId,
            };

            var resp = await client.PostAsJsonAsync("api/categories", req);
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Skapa misslyckades: {(int)resp.StatusCode}";
                return;
            }

            CancelCreate();
            await LoadAsync();
        }
        finally
        {
            isBusy = false;
        }
    }

    private void StartEdit(CategoryDto category)
    {
        editingCategoryId = category.Id;
        editModel.DisplayName = category.IsSystemCategory
            ? category.CustomDisplayName ?? ""
            : category.SystemDisplayName;
    }

    private void CancelEdit()
    {
        editingCategoryId = null;
        editModel.DisplayName = "";
    }

    private async Task SaveEditAsync(int categoryId, bool isSystemCategory)
    {
        if (!isSystemCategory && string.IsNullOrWhiteSpace(editModel.DisplayName))
        {
            errorMessage = "Ange ett namn.";
            return;
        }

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");

            var req = new UpdateCategoryRequest
            {
                SystemDisplayName = !isSystemCategory ? editModel.DisplayName.Trim() : null,
                CustomDisplayName = isSystemCategory ? editModel.DisplayName : null,
            };

            var resp = await client.PutAsJsonAsync($"api/categories/{categoryId}", req);
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Uppdatering misslyckades: {(int)resp.StatusCode}";
                return;
            }

            CancelEdit();
            await LoadAsync();
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task DeleteCategoryAsync(int id)
    {
        if (!await Confirm("Ta bort kategori?"))
            return;

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");
            var resp = await client.DeleteAsync($"api/categories/{id}");
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Radering misslyckades: {(int)resp.StatusCode}";
                return;
            }

            await LoadAsync();
        }
        finally
        {
            isBusy = false;
        }
    }

    private Task<bool> Confirm(string text)
    {
        Console.WriteLine("CONFIRM: " + text);
        return Task.FromResult(true);
    }

    private class CreateCategoryModel
    {
        public string SystemDisplayName { get; set; } = "";
    }

    private class EditCategoryModel
    {
        public string DisplayName { get; set; } = "";
    }

    private class CreateCategoryRequest
    {
        public string SystemDisplayName { get; set; } = "";
        public int GroupId { get; set; }
    }

    private class UpdateCategoryRequest
    {
        public string? SystemDisplayName { get; set; }
        public string? CustomDisplayName { get; set; }
        public bool? IsEnabled { get; set; }
    }

    private IEnumerable<CategoryDto> GetVisibleCategories(CategoryGroupDto group) =>
        group.Categories
            .Where(c => showHiddenCategories || c.IsEnabled)
            .OrderBy(c => c.IsEnabled ? 0 : 1)
            .ThenBy(c => c.SortOrder)
            .ThenBy(c => c.DisplayName);

    private void ToggleColumnMenu() => isColumnMenuOpen = !isColumnMenuOpen;

    private int GetTableColumnSpan() =>
        3
        + (showSystemDisplayColumn ? 1 : 0)
        + (showCustomDisplayColumn ? 1 : 0)
        + (showSortOrderColumn ? 1 : 0);

    private async Task LoadPreferencesAsync()
    {
        try
        {
            var result = await BrowserStorage.GetAsync<ColumnPreferenceState>(PreferenceStorageKey);
            if (result.Success && result.Value is ColumnPreferenceState prefs)
            {
                showHiddenCategories = prefs.ShowHiddenCategories;
                showSystemDisplayColumn = prefs.ShowSystemDisplayName;
                showCustomDisplayColumn = prefs.ShowCustomDisplayName;
                showSortOrderColumn = prefs.ShowSortOrder;
            }
        }
        catch
        {
            // ignore storage errors
        }
    }

    private Task OnPreferencesChanged() => PersistPreferencesAsync();

    private async Task PersistPreferencesAsync()
    {
        try
        {
            var payload = new ColumnPreferenceState
            {
                ShowHiddenCategories = showHiddenCategories,
                ShowSystemDisplayName = showSystemDisplayColumn,
                ShowCustomDisplayName = showCustomDisplayColumn,
                ShowSortOrder = showSortOrderColumn,
            };
            await BrowserStorage.SetAsync(PreferenceStorageKey, payload);
        }
        catch
        {
            // ignore storage errors
        }
    }

    private async Task SetEnabledAsync(int categoryId, bool isEnabled)
    {
        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");
            var req = new UpdateCategoryRequest
            {
                IsEnabled = isEnabled,
            };

            var resp = await client.PutAsJsonAsync($"api/categories/{categoryId}", req);
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Kunde inte uppdatera status: {(int)resp.StatusCode}";
                return;
            }

            await LoadAsync();
        }
        finally
        {
            isBusy = false;
        }
    }

    private class ColumnPreferenceState
    {
        public bool ShowHiddenCategories { get; set; }
        public bool ShowSystemDisplayName { get; set; } = true;
        public bool ShowCustomDisplayName { get; set; } = true;
        public bool ShowSortOrder { get; set; } = true;
    }
}
