@page "/categories"
@rendermode InteractiveServer
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory

<h2 class="mb-4">Kategorier</h2>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isBusy && nodes.Count == 0)
{
    <p><em>Laddar...</em></p>
}
else
{
    @foreach (var system in nodes)
    {
        <div class="mt-4">
            <h3 class="fw-semibold">@system.Category.Name</h3>

            @* Undercategories list *@
            <ul class="list-group list-group-flush mt-2">
                @foreach (var child in system.Children)
                {
                    <li class="list-group-item px-0">

                        @if (editingId == child.Category.Id)
                        {
                            <div class="border rounded p-3 shadow-sm bg-white">

                                <div class="mb-2">
                                    <label class="form-label">Namn</label>
                                    <input class="form-control"
                                           @bind="editModel.Name" />
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Parentkategori</label>
                                    <select class="form-select"
                                            @bind="editModel.ParentCategoryIdString">
                                        @foreach (var sys in nodes)
                                        {
                                            <option value="@sys.Category.Id">
                                                @sys.Category.Name
                                            </option>
                                        }
                                    </select>
                                </div>

                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" disabled="@isBusy"
                                            @onclick="() => SaveEditAsync(child.Category.Id)">
                                        Spara
                                    </button>
                                    <button class="btn btn-secondary" disabled="@isBusy"
                                            @onclick="CancelEdit">
                                        Avbryt
                                    </button>
                                    <button class="btn btn-outline-danger ms-auto" disabled="@isBusy"
                                            @onclick="() => DeleteCategoryAsync(child.Category.Id)">
                                        Ta bort
                                    </button>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-content-between align-items-center py-1 category-row"
                                 role="button"
                                 @onclick="() => StartEdit(child.Category)">
                                <span class="fs-6">@child.Category.Name</span>
                            </div>
                        }

                    </li>
                }

                @* Create new subcategory *@

                <li class="list-group-item px-0">

                    @if (creatingUnderParentId == system.Category.Id)
                    {
                        <div class="border rounded p-3 shadow-sm bg-white">

                            <div class="mb-3">
                                <label class="form-label">Namn</label>
                                <input class="form-control"
                                       @bind="createModel.Name" />
                            </div>

                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" disabled="@isBusy"
                                        @onclick="() => CreateSubCategoryAsync(system.Category.Id)">
                                    Skapa
                                </button>
                                <button class="btn btn-secondary" disabled="@isBusy"
                                        @onclick="CancelCreate">
                                    Avbryt
                                </button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-outline-primary mt-2"
                                @onclick="() => StartCreate(system.Category.Id)">
                            +
                        </button>
                    }
                </li>

            </ul>
        </div>
    }
}

<style>
    .category-row:hover {
        background-color: #f8f9fa;
        border-radius: 4px;
        padding-left: 6px;
        transition: background-color 0.15s ease;
    }
</style>

@code {
    private List<CategoryNode> nodes = new();
    private bool isBusy;
    private string? errorMessage;

    private int? editingId;
    private int? creatingUnderParentId;

    private readonly CreateCategoryModel createModel = new();
    private readonly EditCategoryModel editModel = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        isBusy = true;
        errorMessage = null;
        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var categories = await client.GetFromJsonAsync<List<CategoryDto>>("api/categories") ?? new();

            // Build tree
            var systemNodes = categories
                .Where(c => c.IsSystemCategory)
                .Select(c => new CategoryNode(c))
                .ToList();

            foreach (var child in categories.Where(c => !c.IsSystemCategory))
            {
                var parent = systemNodes.FirstOrDefault(s => s.Category.Id == child.ParentCategoryId);
                parent?.Children.Add(new CategoryNode(child));
            }

            nodes = systemNodes.OrderBy(s => s.Category.Name).ToList();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            errorMessage = "Kunde inte läsa in kategorier.";
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

    // CREATE
    private void StartCreate(int parentId)
    {
        creatingUnderParentId = parentId;
        createModel.Name = "";
    }

    private void CancelCreate()
    {
        creatingUnderParentId = null;
        createModel.Name = "";
    }

    private async Task CreateSubCategoryAsync(int parentId)
    {
        if (string.IsNullOrWhiteSpace(createModel.Name))
        {
            errorMessage = "Ange ett namn.";
            return;
        }

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");

            var req = new CreateCategoryRequest
            {
                Name = createModel.Name.Trim(),
                ParentCategoryId = parentId
            };

            var resp = await client.PostAsJsonAsync("api/categories", req);
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Skapa misslyckades: {(int)resp.StatusCode}";
                return;
            }

            CancelCreate();
            await LoadAsync();
        }
        finally { isBusy = false; }
    }

    // EDIT
    private void StartEdit(CategoryDto category)
    {
        editingId = category.Id;
        editModel.Name = category.Name;
        editModel.ParentCategoryIdString = category.ParentCategoryId?.ToString() ?? "";
    }

    private void CancelEdit()
    {
        editingId = null;
        editModel.Name = "";
        editModel.ParentCategoryIdString = "";
    }

    private async Task SaveEditAsync(int categoryId)
    {
        if (string.IsNullOrWhiteSpace(editModel.Name))
        {
            errorMessage = "Ange ett namn.";
            return;
        }

        if (!int.TryParse(editModel.ParentCategoryIdString, out var parentId))
        {
            errorMessage = "Välj en giltig parent.";
            return;
        }

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");

            var req = new UpdateCategoryRequest
            {
                Name = editModel.Name.Trim(),
                ParentCategoryId = parentId
            };

            var resp = await client.PutAsJsonAsync($"api/categories/{categoryId}", req);
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Uppdatering misslyckades: {(int)resp.StatusCode}";
                return;
            }

            CancelEdit();
            await LoadAsync();
        }
        finally { isBusy = false; }
    }

    // DELETE
    private async Task DeleteCategoryAsync(int id)
    {
        if (!await Confirm($"Ta bort kategori?")) return;

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");

            var resp = await client.DeleteAsync($"api/categories/{id}");
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Radering misslyckades: {(int)resp.StatusCode}";
                return;
            }

            await LoadAsync();
        }
        finally { isBusy = false; }
    }

    private Task<bool> Confirm(string text)
    {
        Console.WriteLine("CONFIRM: " + text);
        return Task.FromResult(true);
    }

    // MODELS

    private class CreateCategoryModel
    {
        public string Name { get; set; } = "";
    }

    private class EditCategoryModel
    {
        public string Name { get; set; } = "";
        public string ParentCategoryIdString { get; set; } = "";
    }

    private class CategoryNode
    {
        public CategoryDto Category { get; }
        public List<CategoryNode> Children { get; } = new();
        public CategoryNode(CategoryDto c) => Category = c;
    }

    public class CategoryDto
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public int? ParentCategoryId { get; set; }
        public bool IsSystemCategory { get; set; }
    }

    public class CreateCategoryRequest
    {
        public string Name { get; set; } = "";
        public int ParentCategoryId { get; set; }
    }

    public class UpdateCategoryRequest
    {
        public string Name { get; set; } = "";
        public int ParentCategoryId { get; set; }
    }
}