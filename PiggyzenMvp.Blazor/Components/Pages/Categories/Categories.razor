@page "/categories"
@rendermode InteractiveServer
@using System.Linq
@using System.Net.Http.Json
@using PiggyzenMvp.Blazor.DTOs
@inject IHttpClientFactory HttpClientFactory

<h2 class="mb-4">Kategorier</h2>

@if (!string.IsNullOrWhiteSpace(errorMessage))
{
    <div class="alert alert-danger">@errorMessage</div>
}

@if (isBusy && groups.Count == 0)
{
    <p><em>Laddar...</em></p>
}
else
{
    @foreach (var group in groups)
    {
        <div class="mt-4">
            <div class="d-flex justify-content-between align-items-center">
                <h3 class="fw-semibold mb-0">@group.DisplayName</h3>
                @if (creatingGroupId != group.Id)
                {
                    <button class="btn btn-sm btn-outline-primary"
                            @onclick="() => StartCreate(group.Id)">
                        + Lägg till kategori
                    </button>
                }
            </div>

            <ul class="list-group list-group-flush mt-2">
                @foreach (var category in group.Categories.OrderBy(c => c.SortOrder).ThenBy(c => c.DisplayName))
                {
                    <li class="list-group-item px-0">
                        @if (editingCategoryId == category.Id)
                        {
                            <div class="border rounded p-3 shadow-sm bg-white">
                                <div class="mb-3">
                                    <label class="form-label">
                                        @(category.IsSystemCategory ? "Visningsnamn (lämna tomt för standard)" : "Namn")
                                    </label>
                                    <input class="form-control"
                                           @bind="editModel.DisplayName" />
                                </div>
                                <div class="form-check mb-3">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           id="hide-@category.Id"
                                           @bind="editModel.IsHidden" />
                                    <label class="form-check-label" for="hide-@category.Id">
                                        Dölj kategori vid val
                                    </label>
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" disabled="@isBusy"
                                            @onclick="() => SaveEditAsync(category.Id, category.IsSystemCategory)">
                                        Spara
                                    </button>
                                    <button class="btn btn-secondary" disabled="@isBusy" @onclick="CancelEdit">
                                        Avbryt
                                    </button>
                                    @if (!category.IsSystemCategory)
                                    {
                                        <button class="btn btn-outline-danger ms-auto" disabled="@isBusy"
                                                @onclick="() => DeleteCategoryAsync(category.Id)">
                                            Ta bort
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="d-flex justify-content-between align-items-center py-1">
                                <div>
                                    <span class="fs-6">@category.EffectiveName</span>
                                    @if (category.IsSystemCategory)
                                    {
                                        <span class="badge bg-light text-dark ms-2">System</span>
                                    }
                                    @if (category.IsHidden)
                                    {
                                        <span class="badge bg-warning text-dark ms-2">Dold</span>
                                    }
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-secondary"
                                            @onclick="() => StartEdit(category)">
                                        Redigera
                                    </button>
                                    @if (!category.IsSystemCategory)
                                    {
                                        <button class="btn btn-sm btn-outline-danger"
                                                @onclick="() => DeleteCategoryAsync(category.Id)">
                                            Ta bort
                                        </button>
                                    }
                                </div>
                            </div>
                        }
                    </li>
                }

                <li class="list-group-item px-0">
                    @if (creatingGroupId == group.Id)
                    {
                        <div class="border rounded p-3 shadow-sm bg-white">
                            <div class="mb-3">
                                <label class="form-label">Namn</label>
                                <input class="form-control"
                                       @bind="createModel.DisplayName" />
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" disabled="@isBusy"
                                        @onclick="() => CreateCategoryAsync(group.Id)">
                                    Skapa
                                </button>
                                <button class="btn btn-secondary" disabled="@isBusy" @onclick="CancelCreate">
                                    Avbryt
                                </button>
                            </div>
                        </div>
                    }
                    else
                    {
                        <button class="btn btn-sm btn-outline-primary mt-2"
                                @onclick="() => StartCreate(group.Id)">
                            + Ny kategori
                        </button>
                    }
                </li>
            </ul>
        </div>
    }
}

@code {
    private List<CategoryGroupDto> groups = new();
    private bool isBusy;
    private string? errorMessage;

    private int? editingCategoryId;
    private int? creatingGroupId;

    private readonly CreateCategoryModel createModel = new();
    private readonly EditCategoryModel editModel = new();

    protected override async Task OnInitializedAsync() => await LoadAsync();

    private async Task LoadAsync()
    {
        isBusy = true;
        errorMessage = null;
        try
        {
            var client = HttpClientFactory.CreateClient("ApiClient");
            var result = await client.GetFromJsonAsync<List<CategoryGroupDto>>("api/categories");
            groups = result?
                .OrderBy(g => g.SortOrder)
                .Select(g =>
                {
                    g.Categories = g.Categories
                        .Where(c => c.IsActive)
                        .OrderBy(c => c.SortOrder)
                        .ThenBy(c => c.DisplayName)
                        .ToList();
                    return g;
                })
                .ToList() ?? new List<CategoryGroupDto>();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
            errorMessage = "Kunde inte läsa in kategorier.";
        }
        finally
        {
            isBusy = false;
            StateHasChanged();
        }
    }

    private void StartCreate(int groupId)
    {
        creatingGroupId = groupId;
        createModel.DisplayName = "";
    }

    private void CancelCreate()
    {
        creatingGroupId = null;
        createModel.DisplayName = "";
    }

    private async Task CreateCategoryAsync(int groupId)
    {
        if (string.IsNullOrWhiteSpace(createModel.DisplayName))
        {
            errorMessage = "Ange ett namn.";
            return;
        }

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");
            var req = new CreateCategoryRequest
            {
                DisplayName = createModel.DisplayName.Trim(),
                GroupId = groupId,
            };

            var resp = await client.PostAsJsonAsync("api/categories", req);
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Skapa misslyckades: {(int)resp.StatusCode}";
                return;
            }

            CancelCreate();
            await LoadAsync();
        }
        finally
        {
            isBusy = false;
        }
    }

    private void StartEdit(CategoryDto category)
    {
        editingCategoryId = category.Id;
        editModel.DisplayName = category.IsSystemCategory
            ? category.UserDisplayName ?? ""
            : category.DisplayName;
        editModel.IsHidden = category.IsHidden;
    }

    private void CancelEdit()
    {
        editingCategoryId = null;
        editModel.DisplayName = "";
        editModel.IsHidden = false;
    }

    private async Task SaveEditAsync(int categoryId, bool isSystemCategory)
    {
        if (!isSystemCategory && string.IsNullOrWhiteSpace(editModel.DisplayName))
        {
            errorMessage = "Ange ett namn.";
            return;
        }

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");

            var req = new UpdateCategoryRequest
            {
                IsHidden = editModel.IsHidden,
                DisplayName = !isSystemCategory ? editModel.DisplayName.Trim() : null,
                UserDisplayName = isSystemCategory ? editModel.DisplayName : null,
            };

            var resp = await client.PutAsJsonAsync($"api/categories/{categoryId}", req);
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Uppdatering misslyckades: {(int)resp.StatusCode}";
                return;
            }

            CancelEdit();
            await LoadAsync();
        }
        finally
        {
            isBusy = false;
        }
    }

    private async Task DeleteCategoryAsync(int id)
    {
        if (!await Confirm("Ta bort kategori?"))
            return;

        try
        {
            isBusy = true;
            var client = HttpClientFactory.CreateClient("ApiClient");
            var resp = await client.DeleteAsync($"api/categories/{id}");
            if (!resp.IsSuccessStatusCode)
            {
                errorMessage = $"Radering misslyckades: {(int)resp.StatusCode}";
                return;
            }

            await LoadAsync();
        }
        finally
        {
            isBusy = false;
        }
    }

    private Task<bool> Confirm(string text)
    {
        Console.WriteLine("CONFIRM: " + text);
        return Task.FromResult(true);
    }

    private class CreateCategoryModel
    {
        public string DisplayName { get; set; } = "";
    }

    private class EditCategoryModel
    {
        public string DisplayName { get; set; } = "";
        public bool IsHidden { get; set; }
    }

    private class CreateCategoryRequest
    {
        public string DisplayName { get; set; } = "";
        public int GroupId { get; set; }
    }

    private class UpdateCategoryRequest
    {
        public string? DisplayName { get; set; }
        public string? UserDisplayName { get; set; }
        public bool? IsHidden { get; set; }
    }
}
